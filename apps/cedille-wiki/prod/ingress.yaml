# apiVersion: networking.k8s.io/v1
# kind: Ingress
# metadata:
#   name: wiki-cedille-ingress
#   annotations:
#     cert-manager.io/cluster-issuer: letsencrypt-prod
#     ingress.kubernetes.io/force-ssl-redirect: "true"
#     kubernetes.io/tls-acme: "true"
# spec:
#   ingressClassName: contour
#   tls:
#     - secretName: wiki-tls
#       hosts:
#         - wiki.omni.cedille.club
#   rules:
#     - host: wiki.omni.cedille.club
#       http:
#         paths:
#           - pathType: Prefix
#             path: /
#             backend:
#               service:
#                 name: wiki-cedille
#                 port:
#                   name: http

apiVersion: projectcontour.io/v1
kind: HTTPProxy
metadata:
  name: wiki-cedille
spec:
  virtualhost:
    fqdn: wiki.omni.cedille.club
  routes:
    - conditions:
        - prefix: /
      timeoutPolicy:
        response: 60s  # Increase to allow ample time for backend response
        idle: 10s      # Set idle timeout to handle slow connections
      retryPolicy:
        count: 3               # Allow up to 3 retries
        perTryTimeout: 15s     # Timeout per retry attempt
      services:
        - name: wiki-cedille
          port: 80
---
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: wiki-tls
spec:
  secretName: wiki-tls
  dnsNames:
    - wiki.omni.cedille.club
  issuerRef:
    name: letsencrypt-prod
    kind: ClusterIssuer
