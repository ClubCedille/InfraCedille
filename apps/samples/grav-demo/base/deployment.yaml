apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: grav-demo
  name: grav-demo
  annotations:
    vault.hashicorp.com/agent-inject: 'true'
    vault.hashicorp.com/agent-inject-secret-grav: 'github/token/grav-demo'
    vault.hashicorp.com/agent-inject-template-grav: |
      {{- with secret "github/token/grav-demo" -}}
      enabled: true
      folders:
        - pages
        - plugins
        - themes
      SyncNotice: null
      sync:
        on_save: true
        on_delete: true
        on_media: true
        cron_enable: true
        cron_at: '*/10 * * * *'
      local_repository: null
      repository: 'https://github.com/ClubCedille/grav-sync-example.git'
      no_user: '1'
      user: null
      password: {{ .Data.token }}
      webhook_enabled: '0'
      branch: main
      remote:
        name: origin
        branch: master
      git:
        author: gitsync
        message: '(Grav GitSync) Automatic Commit'
        name: GitSync
        email: git-sync@trilby.media
        bin: git
        ignore: null
        private_key: null
      logging: false
      {{- end }}
    vault.hashicorp.com/role: 'secret-reader'
spec:
  replicas: 1
  selector:
    matchLabels:
      app: grav-demo
  template:
    metadata:
      labels:
        app: grav-demo
    spec:
      initContainers:
      - name: post-init-task
        image: ghcr.io/clubcedille/grav:0.0.1
        imagePullPolicy: Always
        volumeMounts:
        - name: grav-storage
          mountPath: /var/www/html
      containers:
      - name: grav-demo
        image: clubcedille/grav:0.0.4
        imagePullPolicy: Always
        ports:
        - containerPort: 80
        volumeMounts:
        - name: grav-storage
          mountPath: /var/www/html
        # TODO add readinessProbe once we have the admin configuration as code for grav
        # readinessProbe:
        #   httpGet:
        #     path: /
        #     port: 80
        #   initialDelaySeconds: 10
        #   periodSeconds: 5
      volumes:
      - name: grav-storage
        persistentVolumeClaim:
          claimName: grav-pvc
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: grav-pvc
spec:
  accessModes:
    - "ReadWriteOnce"
  resources:
    requests:
      storage: "1G"